<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NapCash â€“ Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; }
  .nav { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#111; }
  .brand { color:orange; font-size:1.5rem; font-weight:bold; }
  .btn-orange { background:orange; border:none; color:black; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.3s; }
  .btn-orange:disabled { background:gray; color:#ddd; cursor:not-allowed; }
  .btn-orange:hover:enabled { background:#ff9900; color:#fff; }
  .hero { max-width:1100px; margin:20px auto; padding:20px; }
  .card { background:#111; padding:25px; border-radius:12px; margin-bottom:20px; }
  .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-top:20px; }
  .info-card { background:#222; padding:20px; border-radius:10px; text-align:center; }
  .info-card h3 { color:orange; margin-bottom:10px; }
  input#refLink { width:100%; padding:5px; border:none; border-radius:5px; color:#000; margin-bottom:8px; }
  .referral-list, .withdrawal-list { list-style:none; padding-left:0; margin-top:10px; }
  .referral-list li, .withdrawal-list li { display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border-radius:6px; margin-bottom:8px; }
  .status-badge { font-size:0.8rem; padding:4px 8px; border-radius:4px; font-weight:bold; color:#fff; }
  .active { background:green; }
  .pending { background:orange; }
</style>
</head>
<body>
<div class="nav">
  <div class="brand">NapCash</div>
  <div>
    <button id="profileBtn" class="btn-orange">Profile</button>
    <span id="userEmail" style="margin-left:10px;"></span>
    <button id="logoutBtn" class="btn-orange" style="margin-left:10px;">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate Account</button>
      </div>
      <div class="info-card">
        <h3>Balance</h3>
        <p>KSh <span id="earnings">0</span></p>
        <button id="withdrawBtn" class="btn-orange" style="margin-top:10px;">Withdraw</button>
      </div>
      <div class="info-card">
        <h3>Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>People You Referred</h3>
    <ul id="referralsList" class="referral-list"><li>Loading...</li></ul>
  </div>

  <div class="card">
    <h3>Your Withdrawals</h3>
    <ul id="withdrawalsList" class="withdrawal-list"><li>Loading...</li></ul>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const earningsSpan = document.getElementById("earnings");
const refCodeSpan = document.getElementById("refCode");
const refLinkInput = document.getElementById("refLink");
const copyBtn = document.getElementById("copyBtn");
const statusText = document.getElementById("status");
const activateBtn = document.getElementById("activateBtn");
const userEmail = document.getElementById("userEmail");
const logoutBtn = document.getElementById("logoutBtn");
const profileBtn = document.getElementById("profileBtn");
const withdrawBtn = document.getElementById("withdrawBtn");
const referralsList = document.getElementById("referralsList");
const withdrawalsList = document.getElementById("withdrawalsList");

let uid, userData;

auth.onAuthStateChanged(async user => {
  if (!user) return window.location.href = "login.html";
  uid = user.uid;

  // Fetch user doc
  const userDoc = await db.collection("users").doc(uid).get();
  if(!userDoc.exists) {
    alert("Account not registered in database. Contact support.");
    await auth.signOut();
    return window.location.href = "login.html";
  }
  userData = userDoc.data();
  userEmail.textContent = userData.fullName || userData.email;
  refCodeSpan.textContent = userData.referralCode;
  const referralLink = `https://naptile.github.io/refferal-napcash/register.html?ref=${userData.referralCode}`;
  refLinkInput.value = referralLink;
  statusText.textContent = userData.status || "pending";

  if(userData.status === "active") activateBtn.style.display="none";

  // Copy referral link
  copyBtn.onclick = () => navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!"));

  // Activate account
  activateBtn.onclick = () => {
    const msg = `Hi Admin, I want to activate my account. My name is ${userData.fullName}`;
    const url = `https://wa.me/254718439373?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  };

  // Profile
  profileBtn.onclick = () => {
    alert(`Profile Info:\n\nFull Name: ${userData.fullName}\nEmail: ${userData.email}\nStatus: ${userData.status}\nReferral Code: ${userData.referralCode}`);
  };

  // Real-time People Referred
  db.collection("users").where("referredBy","==",userData.referralCode)
    .onSnapshot(snapshot => {
      referralsList.innerHTML = "";
      if(snapshot.empty){
        referralsList.innerHTML = "<li>No one has used your referral link yet</li>";
        earningsSpan.textContent = 0;
        return;
      }
      let activeCount = 0;
      snapshot.forEach(doc => {
        const d = doc.data();
        if(d.status === "active") activeCount++;
        const li = document.createElement("li");
        li.innerHTML = `<span>${d.fullName || d.email}</span>
                        <span class="status-badge ${d.status==="active"?"active":"pending"}">${d.status.toUpperCase()}</span>`;
        referralsList.appendChild(li);
      });
      earningsSpan.textContent = activeCount * 50 - (userData.lastWithdrawCount || 0)*50;
    });

  // Real-time Withdrawals
  db.collection("withdrawals").where("userId","==",uid).orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      withdrawalsList.innerHTML="";
      if(snap.empty){ withdrawalsList.innerHTML="<li>No withdrawals yet</li>"; return; }
      snap.forEach(doc=>{
        const d = doc.data();
        const createdAt = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "N/A";
        const li = document.createElement("li");
        li.innerHTML = `<div style="flex:1;text-align:left;">
                          <strong>KSh ${d.amount}</strong><br>
                          <small>${createdAt} | ${d.method || "Mpesa"}</small>
                        </div>
                        <span class="status-badge ${d.status==="paid"?"active":"pending"}">${d.status.toUpperCase()}</span>`;
        withdrawalsList.appendChild(li);
      });
    });

  // Withdraw
  withdrawBtn.onclick = async () => {
    if(userData.status !== "active"){ alert("Activate account first."); return; }
    const activeRefs = await db.collection("users").where("referredBy","==",userData.referralCode).where("status","==","active").get();
    const newEarnings = activeRefs.size * 50 - (userData.lastWithdrawCount || 0)*50;
    if(newEarnings <= 0){ alert("No earnings to withdraw!"); return; }

    await db.collection("withdrawals").add({
      userId: uid,
      amount: newEarnings,
      status: "pending",
      method: userData.paymentMethod || "Mpesa",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection("users").doc(uid).update({
      lastWithdrawCount: activeRefs.size,
      withdrawalRequested: true,
      withdrawalRequestedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    earningsSpan.textContent = 0;
    alert("Withdrawal request sent!");
  };
});

// Logout
logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.href="login.html";
};
</script>
</body>
</html>
