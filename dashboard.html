<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash â€“ Dashboard</title>
  <link rel="stylesheet" href="styles/dash2.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { background:#000; color:#fff; margin:0; font-family: Arial, sans-serif; }
    .nav { display:flex; align-items:center; justify-content:space-between; padding:15px 20px; background:#111; position:relative; }
    .brand { font-size:1.5rem; color:orange; font-weight:bold; }
    .hamburger { display:none; font-size:2rem; cursor:pointer; color:orange; margin-right:10px; }
    .nav-links { display:flex; gap:10px; align-items:center; }
    .btn-orange { background:orange; border:none; color:black; font-weight:bold; padding:8px 12px; border-radius:6px; cursor:pointer; transition:0.3s; }
    .btn-orange:disabled { background:gray; color:#ddd; cursor:not-allowed; }
    .btn-orange:hover:enabled { background:#ff9900; color:#fff; }
    .hero { max-width:1000px; margin:20px auto; padding:20px; }
    .card { background:#111; padding:25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
    .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:20px; }
    .info-card { background:#222; padding:20px; border-radius:10px; text-align:center; transition:0.2s; }
    .info-card h3 { color:orange; margin-bottom:8px; }
    input#refLink { width:100%; padding:5px; border:none; border-radius:5px; color:#000; margin-bottom:8px; }
    .referral-list, .withdrawal-list { list-style:none; padding-left:0; margin-top:10px; }
    .referral-list li, .withdrawal-list li { display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border-radius:6px; margin-bottom:8px; }
    .referral-list li span.status, .withdrawal-list li span.status { font-weight:bold; padding:4px 8px; border-radius:4px; font-size:0.85rem; color:#fff; }
  </style>
</head>
<body>

<div class="nav">
  <div class="hamburger" id="hamburger">&#9776;</div>
  <div class="brand">NapCash</div>
  <div class="nav-links" id="navLinks">
    <button id="profileBtn" class="btn-orange">Profile</button>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn-orange">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate</button>
      </div>
      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
        <button id="withdrawBtn" class="btn-orange" style="margin-top:10px;">Withdraw</button>
        <p id="withdrawStatus" style="margin-top:8px; font-size:0.9rem; color:orange;"></p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>
    </div>

    <div style="margin-top:20px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>

    <div style="margin-top:20px;">
      <h3>Your Withdrawals</h3>
      <ul id="withdrawalsList" class="withdrawal-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const withdrawBtn = document.getElementById("withdrawBtn");
const withdrawStatus = document.getElementById("withdrawStatus");
const earningsSpan = document.getElementById("earnings");
const withdrawalsList = document.getElementById("withdrawalsList");
const refCodeSpan = document.getElementById("refCode");
const refLinkInput = document.getElementById("refLink");
const copyBtn = document.getElementById("copyBtn");

// Auth listener
auth.onAuthStateChanged(async user => {
  if (!user) return window.location.href="/login.html";
  const uid = user.uid;
  const userDoc = await db.collection("users").doc(uid).get();
  if (!userDoc.exists) return;
  const data = userDoc.data();

  // Referral link
  refCodeSpan.textContent = data.referralCode;
  const referralLink = `${window.location.origin}/register.html?ref=${data.referralCode}`;
  refLinkInput.value = referralLink;
  copyBtn.onclick = ()=>navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!"));

  // Earnings calculation
  const activeRefSnap = await db.collection("users")
    .where("referredBy","==",data.referralCode)
    .where("status","==","active")
    .get();

  let totalEarnings = activeRefSnap.size * 50;
  earningsSpan.textContent = totalEarnings;

  // Withdrawals history
  db.collection("withdrawals").where("userId","==",uid).orderBy("createdAt","desc").onSnapshot(snap=>{
    withdrawalsList.innerHTML="";
    if(snap.empty){ 
      withdrawalsList.innerHTML="<li>No withdrawals yet</li>"; 
      updateWithdrawBtn(totalEarnings, null);
      return; 
    }

    snap.forEach((doc,i)=>{
      const d = doc.data();
      const li = document.createElement("li");
      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "N/A";
      li.innerHTML = `
        <div style="flex:1;text-align:left;">
          <strong>KSh ${d.amount}</strong><br>
          <small>${createdAt} | ${d.method || "Mpesa"}</small>
        </div>
        <span class="status" style="background:${d.status==="paid"?"green":d.status==="pending"?"orange":"red"}">${d.status.toUpperCase()}</span>`;
      withdrawalsList.appendChild(li);

      if(i===0){ // last withdrawal
        updateWithdrawBtn(totalEarnings, d.status);
        withdrawStatus.textContent = `Last withdrawal: ${d.status.toUpperCase()}`;
      }
    });
  });

  // Withdraw request
  withdrawBtn.onclick = async ()=>{
    if(totalEarnings <= 0) return;
    await db.collection("withdrawals").add({
      userId: uid,
      amount: totalEarnings,
      status: "pending",
      method: data.paymentMethod || "Mpesa",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection("users").doc(uid).update({ earnings: 0 });
    earningsSpan.textContent = 0;
    updateWithdrawBtn(0, "pending");
    withdrawStatus.textContent = "Last withdrawal: PENDING";
    alert("Withdrawal request sent!");
  };

  function updateWithdrawBtn(earnings, lastStatus){
    if(lastStatus==="pending"){
      withdrawBtn.textContent="Withdraw (Pending...)";
      withdrawBtn.disabled=true;
    }else if(lastStatus==="paid" && earnings<=0){
      withdrawBtn.textContent="Withdraw (No Earnings)";
      withdrawBtn.disabled=true;
    }else if(earnings<=0){
      withdrawBtn.textContent="Withdraw (No Earnings)";
      withdrawBtn.disabled=true;
    }else{
      withdrawBtn.textContent="Withdraw";
      withdrawBtn.disabled=false;
    }
  }
});
</script>
</body>
</html>
