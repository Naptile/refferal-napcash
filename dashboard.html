<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NapCash â€“ Dashboard</title>
<link rel="stylesheet" href="styles/dash2.css">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
body { background:#000; color:#fff; margin:0; font-family: Arial, sans-serif; }
.nav { display:flex; align-items:center; justify-content:space-between; padding:15px 20px; background:#111; }
.brand { font-size:1.5rem; color:orange; font-weight:bold; }
.btn-orange { background:orange; border:none; color:black; font-weight:bold; padding:8px 12px; border-radius:6px; cursor:pointer; transition:0.3s; }
.btn-orange:disabled { background:gray; color:#ddd; cursor:not-allowed; }
.btn-orange:hover:enabled { background:#ff9900; color:#fff; }
.hero { max-width:1000px; margin:20px auto; padding:20px; }
.card { background:#111; padding:25px; border-radius:12px; }
.dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:20px; }
.info-card { background:#222; padding:20px; border-radius:10px; text-align:center; }
.info-card h3 { color:orange; margin-bottom:8px; }
input#refLink { width:100%; padding:5px; border:none; border-radius:5px; color:#000; margin-bottom:8px; }
.referral-list, .withdrawal-list { list-style:none; padding-left:0; margin-top:10px; }
.referral-list li, .withdrawal-list li { display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border-radius:6px; margin-bottom:8px; }
.status-badge { font-size:0.8rem; padding:4px 8px; border-radius:4px; font-weight:bold; color:#fff; }
.active { background:green; }
.inactive { background:orange; }

/* Profile modal */
#profileModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
#profileModal div { background:#111; padding:20px; border-radius:12px; max-width:400px; width:90%; }
#profileModal input { width:100%; margin-bottom:10px; padding:5px; border-radius:5px; border:none; }
</style>
</head>
<body>

<div class="nav">
  <div class="brand">NapCash</div>
  <div class="nav-links">
    <button id="profileBtn" class="btn-orange">Profile</button>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn-orange">Logout</button>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal">
  <div>
    <h3 style="color:orange;">Edit Profile</h3>
    <label>Full Name</label>
    <input type="text" id="profileFullName">
    <label>Email</label>
    <input type="email" id="profileEmail" disabled>
    <label>Phone</label>
    <input type="text" id="profilePhone">
    <label>Payment Method</label>
    <input type="text" id="profilePaymentMethod">
    <div style="text-align:right;">
      <button id="closeProfileBtn" class="btn-orange" style="margin-right:5px;">Cancel</button>
      <button id="saveProfileBtn" class="btn-orange">Save</button>
    </div>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate</button>
      </div>
      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
        <button id="withdrawBtn" class="btn-orange" style="margin-top:10px;">Withdraw</button>
        <p id="withdrawStatus" style="margin-top:8px; font-size:0.9rem; color:orange;"></p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>
    </div>

    <div style="margin-top:20px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>

    <div style="margin-top:20px;">
      <h3>Your Withdrawals</h3>
      <ul id="withdrawalsList" class="withdrawal-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const withdrawBtn = document.getElementById("withdrawBtn");
const withdrawStatus = document.getElementById("withdrawStatus");
const earningsSpan = document.getElementById("earnings");
const withdrawalsList = document.getElementById("withdrawalsList");
const refCodeSpan = document.getElementById("refCode");
const refLinkInput = document.getElementById("refLink");
const copyBtn = document.getElementById("copyBtn");
const statusText = document.getElementById("status");
const activateBtn = document.getElementById("activateBtn");
const userEmail = document.getElementById("userEmail");
const logoutBtn = document.getElementById("logoutBtn");

// Profile Modal
const profileModal = document.getElementById("profileModal");
const profileBtn = document.getElementById("profileBtn");
const closeProfileBtn = document.getElementById("closeProfileBtn");
const saveProfileBtn = document.getElementById("saveProfileBtn");

const profileFullName = document.getElementById("profileFullName");
const profileEmail = document.getElementById("profileEmail");
const profilePhone = document.getElementById("profilePhone");
const profilePaymentMethod = document.getElementById("profilePaymentMethod");

let userData = null;
let uid = null;

auth.onAuthStateChanged(async user => {
  if(!user) return window.location.href="https://naptile.github.io/refferal-napcash/login.html";
  uid = user.uid;
  const userDoc = await db.collection("users").doc(uid).get();
  if(!userDoc.exists) return;
  userData = userDoc.data();

  userEmail.textContent = userData.fullName || userData.email;
  statusText.textContent = userData.status || "pending";

  if(userData.status==="active") activateBtn.style.display="none";

  activateBtn.onclick = ()=>{
    const msg = `Hi Admin, I want to activate my account. My name is ${userData.fullName}`;
    const url = `https://wa.me/254718439373?text=${encodeURIComponent(msg)}`;
    window.open(url,"_blank");
  };

  refCodeSpan.textContent = userData.referralCode;
  const referralLink = `https://naptile.github.io/refferal-napcash/register.html?ref=${userData.referralCode}`;
  refLinkInput.value = referralLink;
  copyBtn.onclick = ()=>navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!"));

  // ... you can keep all your existing dashboard logic here, like earnings, withdrawals, referrals ...
});

// Profile Modal
profileBtn.onclick = () => {
  if(!userData) return;
  profileFullName.value = userData.fullName || "";
  profileEmail.value = userData.email || "";
  profilePhone.value = userData.phone || "";
  profilePaymentMethod.value = userData.paymentMethod || "";
  profileModal.style.display = "flex";
};
closeProfileBtn.onclick = () => profileModal.style.display = "none";
saveProfileBtn.onclick = async () => {
  const updatedData = {
    fullName: profileFullName.value.trim(),
    phone: profilePhone.value.trim(),
    paymentMethod: profilePaymentMethod.value.trim()
  };
  await db.collection("users").doc(uid).update(updatedData);
  alert("Profile updated successfully!");
  userEmail.textContent = updatedData.fullName || userData.email;
  userData = { ...userData, ...updatedData };
  profileModal.style.display = "none";
};

// Logout
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  window.location.href="https://naptile.github.io/refferal-napcash/login.html";
};
</script>
</body>
</html>
