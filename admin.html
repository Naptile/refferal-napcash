<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash – Admin Dashboard</title>
  <link rel="stylesheet" href="styles/admin.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* Make tables scrollable on mobile */
    .users-table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
    }
    .users-table th, .users-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #444;
    }
    .bg { background:#000; color:#fff; font-family: Arial, sans-serif; margin:0; padding:0; }
    .nav { display:flex; justify-content:space-between; padding:15px; background:#111; }
    .brand { color:orange; font-weight:bold; font-size:1.5rem; }
    .card { background:#111; padding:20px; margin:20px; border-radius:10px; }
    button { cursor:pointer; }
  </style>
</head>
<body class="bg">

<div class="nav">
  <div class="brand">NapCash Admin</div>
  <div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Admin Dashboard</h2>

    <!-- Users Table -->
    <h3>All Users</h3>
    <table class="users-table">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Referral Code</th>
          <th>Earnings (KSh)</th>
          <th>Active Referrals</th>
          <th>Referred By</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr><td colspan="9">Loading users...</td></tr>
      </tbody>
    </table>

    <!-- Withdrawals Table -->
    <h3 style="margin-top:40px;">Withdrawal Requests</h3>
    <table class="users-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Amount (KSh)</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTableBody">
        <tr><td colspan="6">Loading withdrawals...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const usersTableBody = document.getElementById("usersTableBody");
const withdrawalsTableBody = document.getElementById("withdrawalsTableBody");
const logoutBtn = document.getElementById("logoutBtn");

let allUsers = [];

auth.onAuthStateChanged(async user => {
  if (!user) return window.location.href = "login.html";
  await loadUsers();
  await loadWithdrawals();
});

// Load Users
async function loadUsers() {
  const snapshot = await db.collection("users").orderBy("createdAt", "desc").get();
  allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  renderUsers(allUsers);
}

// Render Users Table
async function renderUsers(users) {
  if (users.length === 0) {
    usersTableBody.innerHTML = "<tr><td colspan='9'>No users found</td></tr>";
    return;
  }

  usersTableBody.innerHTML = "";
  for (const u of users) {
    // Count active referrals for this user
    const refSnap = await db.collection("users")
      .where("referredBy","==", u.referralCode)
      .where("status","==","active")
      .get();
    const activeReferrals = refSnap.size;

    const tr = document.createElement("tr");
    let actionButtons = "";
    if (u.status === "pending") {
      actionButtons += `<button onclick="activateUser('${u.id}')">Activate</button>`;
      actionButtons += `<button onclick="deactivateUser('${u.id}')">Deactivate</button>`;
    } else if (u.status === "active") {
      actionButtons += `<button onclick="deactivateUser('${u.id}')">Deactivate</button>`;
    } else if (u.status === "deactivated") {
      actionButtons += `<button onclick="activateUser('${u.id}')">Activate</button>`;
    }

    tr.innerHTML = `
      <td>${u.fullName || "N/A"}</td>
      <td>${u.email || "N/A"}</td>
      <td>${u.phone || "N/A"}</td>
      <td>${u.status || "pending"}</td>
      <td>${u.referralCode || "N/A"}</td>
      <td>${u.earnings || 0}</td>
      <td>${activeReferrals}</td>
      <td>${u.referredBy || "None"}</td>
      <td>${actionButtons}</td>
    `;
    usersTableBody.appendChild(tr);
  }
}

// Activate/Deactivate Users
async function activateUser(userId) {
  await db.collection("users").doc(userId).update({ status: "active" });
  alert("User activated!");
  loadUsers();
}
async function deactivateUser(userId) {
  await db.collection("users").doc(userId).update({ status: "deactivated" });
  alert("User deactivated!");
  loadUsers();
}

// Load Withdrawals
async function loadWithdrawals() {
  const snapshot = await db.collection("withdrawals").orderBy("createdAt","desc").get();
  if(snapshot.empty){
    withdrawalsTableBody.innerHTML = "<tr><td colspan='6'>No withdrawals yet</td></tr>";
    return;
  }

  withdrawalsTableBody.innerHTML = "";
  for(const doc of snapshot.docs){
    const w = doc.data();
    const userDoc = await db.collection("users").doc(w.userId).get();
    const userData = userDoc.exists ? userDoc.data() : {};

    const tr = document.createElement("tr");
    const date = w.createdAt ? w.createdAt.toDate().toLocaleString() : "Unknown";

    let actionCell = w.status === "pending" ? `<button onclick="markPaid('${doc.id}', '${w.userId}')">Mark Paid</button>` : "—";

    tr.innerHTML = `
      <td>${userData.fullName || "Unknown"}</td>
      <td>${userData.email || "Unknown"}</td>
      <td>${w.amount}</td>
      <td>${w.status}</td>
      <td>${date}</td>
      <td>${actionCell}</td>
    `;
    withdrawalsTableBody.appendChild(tr);
  }
}

// Mark Withdrawal as Paid + reset user earnings
async function markPaid(withdrawalId, userId) {
  // Mark withdrawal paid
  await db.collection("withdrawals").doc(withdrawalId).update({ status: "paid" });

  // Get user and update earnings + lastWithdrawCount
  const userRef = db.collection("users").doc(userId);
  const userDoc = await userRef.get();
  if(userDoc.exists){
    const u = userDoc.data();
    const activeRefSnap = await db.collection("users")
      .where("referredBy","==", u.referralCode)
      .where("status","==","active")
      .get();
    await userRef.update({
      earnings: 0,
      lastWithdrawCount: activeRefSnap.size,
      withdrawalRequested: false,
      withdrawalRequestedAt: null
    });
  }

  alert("Withdrawal marked as Paid and user earnings reset.");
  loadWithdrawals();
  loadUsers();
}

// Logout
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  window.location.href = "login.html";
};
</script>
</body>
</html>
