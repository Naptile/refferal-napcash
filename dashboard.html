<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash â€“ Dashboard</title>
  <link rel="stylesheet" href="styles/dash2.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: #000; color: #fff; margin:0; font-family: Arial, sans-serif; }
    .nav { display:flex; align-items:center; justify-content:space-between; padding:15px 20px; background:#111; position:relative; }
    .brand { font-size:1.5rem; color:orange; font-weight:bold; }
    .hamburger { display:none; font-size:2rem; cursor:pointer; color:orange; margin-right:10px; }
    .nav-links { display:flex; gap:10px; align-items:center; }
    .btn-orange { background:orange; border:none; color:black; font-weight:bold; padding:8px 12px; border-radius:6px; cursor:pointer; transition:0.3s; }
    .btn-orange:hover { background:#ff9900; color:#fff; }
    .btn-disabled { background:#555 !important; color:#ccc !important; cursor:not-allowed !important; }
    .hero { max-width:1000px; margin:20px auto; padding:20px; }
    .card { background:#111; padding:25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
    .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:20px; }
    .info-card { background:#222; padding:20px; border-radius:10px; text-align:center; transition:0.2s; }
    .info-card h3 { color:orange; margin-bottom:8px; }
    input#refLink { width:100%; padding:5px; border:none; border-radius:5px; color:#000; margin-bottom:8px; }
    .referral-list { list-style:none; padding-left:0; margin-top:10px; }
    .referral-list li { display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border-radius:6px; margin-bottom:8px; }
    .referral-list li span.status { font-weight:bold; padding:4px 8px; border-radius:4px; font-size:0.85rem; color:#fff; }
    @media (max-width:768px){
      .hamburger{display:block;}
      .nav-links { display:none; flex-direction:column; background:#222; position:absolute; top:60px; left:0; width:100%; padding:15px; gap:10px; border-top:1px solid orange; }
      .dashboard-grid { grid-template-columns:1fr; gap:15px; }
      .hero { padding:15px; }
      .card { padding:15px; }
      .info-card { font-size:0.95rem; padding:15px; }
      .referral-list li { font-size:0.9rem; padding:10px; }
      #refLink { font-size:0.9rem; }
      button { padding:12px; font-size:0.95rem; }
    }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#111; padding:20px; border-radius:10px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:10px; }
    .modal-content input { padding:8px; border-radius:5px; border:none; }
    .close-modal { align-self:flex-end; cursor:pointer; font-size:1.2rem; color:orange; }
  </style>
</head>
<body>

<div class="nav">
  <div class="hamburger" id="hamburger">&#9776;</div>
  <div class="brand">NapCash</div>
  <div class="nav-links" id="navLinks">
    <button id="profileBtn" class="btn-orange">Profile</button>
    <button id="withdrawBtn" class="btn-orange">Withdraw</button>
    <button id="referralBtn" class="btn-orange">Referrals</button>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn-orange">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate</button>
      </div>
      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>
    </div>
    <div style="margin-top:20px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<div class="modal" id="profileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h3>Update Profile</h3>
    <input type="text" id="modalName" placeholder="Full Name">
    <input type="email" id="modalEmail" placeholder="Email">
    <input type="tel" id="modalPhone" placeholder="Phone">
    <button id="saveProfileBtn" class="btn-orange">Save</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const repoPath = "/refferal-napcash";
const whatsappNumber = "+254718439373";

// Elements
const hamburger = document.getElementById("hamburger");
const navLinks = document.getElementById("navLinks");
const userEmailSpan = document.getElementById("userEmail");
const statusSpan = document.getElementById("status");
const refCodeSpan = document.getElementById("refCode");
const earningsSpan = document.getElementById("earnings");
const refLinkInput = document.getElementById("refLink");
const referralsList = document.getElementById("referralsList");
const logoutBtn = document.getElementById("logoutBtn");
const copyBtn = document.getElementById("copyBtn");
const activateBtn = document.getElementById("activateBtn");
const withdrawBtn = document.getElementById("withdrawBtn");
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const closeModal = document.getElementById("closeModal");
const modalName = document.getElementById("modalName");
const modalEmail = document.getElementById("modalEmail");
const modalPhone = document.getElementById("modalPhone");
const saveProfileBtn = document.getElementById("saveProfileBtn");

// Hamburger
hamburger.onclick = () => {
  navLinks.style.display = navLinks.style.display === "flex" ? "none" : "flex";
};
navLinks.querySelectorAll("button").forEach(btn => {
  btn.onclick = () => { if(window.innerWidth<=768) navLinks.style.display="none"; };
});

// WhatsApp Activation
function openWhatsApp(fullName){
  const message = encodeURIComponent(`Hi Admin, I want to activate my account. My name is ${fullName}`);
  window.open(`https://wa.me/${whatsappNumber.replace(/\D/g,'')}?text=${message}`,"_blank");
}

// Auth
auth.onAuthStateChanged(async user => {
  if(!user){ window.location.href=`${repoPath}/login.html`; return; }
  const uid = user.uid;
  const userDoc = await db.collection("users").doc(uid).get();
  if(!userDoc.exists) return;
  const data = userDoc.data();
  const fullName = data.fullName || data.name || "User";

  userEmailSpan.textContent = data.email;
  statusSpan.textContent = data.status;
  refCodeSpan.textContent = data.referralCode;

  const referralLink = `${window.location.origin}${repoPath}/register.html?ref=${data.referralCode}`;
  refLinkInput.value = referralLink;
  copyBtn.onclick = ()=>navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!")).catch(()=>alert("Failed to copy"));

  const refSnap = await db.collection("users").where("referredBy","==",data.referralCode).get();
  referralsList.innerHTML="";
  if(!refSnap.empty){
    refSnap.docs.forEach(doc=>{
      const d = doc.data();
      const li=document.createElement("li");
      li.style.display="flex"; li.style.justifyContent="space-between"; li.style.alignItems="center";
      li.style.padding="10px"; li.style.borderRadius="6px"; li.style.marginBottom="8px"; li.style.backgroundColor="#222";
      const nameSpan=document.createElement("span");
      nameSpan.textContent = d.fullName || d.name;
      const statusSpanBadge=document.createElement("span");
      statusSpanBadge.textContent = d.status.toUpperCase();
      statusSpanBadge.classList.add("status");
      statusSpanBadge.style.backgroundColor = d.status === "active" ? "green" : "orange";
      li.appendChild(nameSpan);
      li.appendChild(statusSpanBadge);
      referralsList.appendChild(li);
    });
  } else { referralsList.innerHTML="<li>No referrals yet</li>"; }

  let totalEarnings = 0;
  const activeRefSnap = await db.collection("users")
                                .where("referredBy","==",data.referralCode)
                                .where("status","==","active")
                                .get();
  activeRefSnap.forEach(doc => totalEarnings += 50);
  earningsSpan.textContent = totalEarnings;

  // Withdraw button logic
  if(data.status !== "active"){
    withdrawBtn.textContent = "Activate account to withdraw";
    withdrawBtn.classList.add("btn-disabled");
    withdrawBtn.onclick = () => openWhatsApp(fullName);
  } else if(totalEarnings <= 0){
    withdrawBtn.textContent = "No earnings to withdraw";
    withdrawBtn.classList.add("btn-disabled");
    withdrawBtn.onclick = null;
  } else {
    withdrawBtn.textContent = "Withdraw";
    withdrawBtn.classList.remove("btn-disabled");
    withdrawBtn.onclick = async () => {
      await db.collection("withdrawals").add({
        userId: uid,
        amount: totalEarnings,
        status: "pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      earningsSpan.textContent = "0";
      totalEarnings = 0;
      withdrawBtn.textContent = "No earnings to withdraw";
      withdrawBtn.classList.add("btn-disabled");
      withdrawBtn.onclick = null;
      alert("Withdrawal request sent! Admin will process it shortly.");
    };
  }

  if(data.status !== "active"){
    activateBtn.style.display = "inline-block";
    activateBtn.onclick = () => openWhatsApp(fullName);
  } else { activateBtn.style.display = "none"; }

  profileBtn.onclick = () => {
    modalName.value = data.fullName || data.name || "";
    modalEmail.value = data.email || "";
    modalPhone.value = data.phone || "";
    profileModal.style.display = "flex";
  };

  // Track paid withdrawals only once
  let handledPaidWithdrawals = new Set();
  db.collection("withdrawals")
    .where("userId", "==", uid)
    .where("status", "==", "paid")
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        const id = change.doc.id;
        if(change.type === "added" && !handledPaidWithdrawals.has(id)){
          handledPaidWithdrawals.add(id);
          earningsSpan.textContent = "0";
          alert("Your withdrawal has been processed and marked as paid!");
        }
      });
    });
});

closeModal.onclick = () => profileModal.style.display = "none";
window.onclick = e => { if(e.target===profileModal) profileModal.style.display="none"; };
saveProfileBtn.onclick = async () => {
  const user = auth.currentUser;
  if(!user) return;
  const uid = user.uid;
  await db.collection("users").doc(uid).update({
    fullName: modalName.value,
    email: modalEmail.value,
    phone: modalPhone.value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Profile updated!");
  profileModal.style.display = "none";
};

logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.href = `${repoPath}/login.html`;
};
</script>
</body>
</html>

