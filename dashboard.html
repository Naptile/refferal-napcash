<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash â€“ Dashboard</title>
  <link rel="stylesheet" href="styles/dash2.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* Mobile-Friendly Dashboard */
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr; /* stack cards vertically */
            gap: 15px;
        }

        .nav {
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
        }

        .nav div {
            margin-top: 10px;
        }

        .info-card {
            padding: 15px;
            font-size: 0.95rem;
        }

        .referral-list li {
            font-size: 0.9rem;
            padding: 10px;
        }

        .hero {
            padding: 20px 10px;
        }

        .card {
            padding: 20px;
        }

        #refLink {
            font-size: 0.9rem;
        }

        button {
            padding: 12px;
            font-size: 0.95rem;
        }
    }
  </style>
</head>
<body class="bg">

<div class="nav">
  <div class="brand">NapCash</div>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>

    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
      </div>

      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>

      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
      </div>

      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly style="width:100%; padding:5px; border-radius:5px; border:none; color:#000;">
        <button id="copyBtn">Copy Link</button>
      </div>

      <div class="info-card">
        <h3>Withdraw</h3>
        <button id="withdrawBtn">Withdraw</button>
      </div>
    </div>

    <div style="margin-top:30px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
    authDomain: "napcash-3e696.firebaseapp.com",
    projectId: "napcash-3e696",
    storageBucket: "napcash-3e696.firebasestorage.app",
    messagingSenderId: "720221815295",
    appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const repoPath = "/refferal-napcash";

  const userEmailSpan = document.getElementById("userEmail");
  const statusSpan = document.getElementById("status");
  const refCodeSpan = document.getElementById("refCode");
  const earningsSpan = document.getElementById("earnings");
  const refLinkInput = document.getElementById("refLink");
  const referralsList = document.getElementById("referralsList");
  const logoutBtn = document.getElementById("logoutBtn");
  const copyBtn = document.getElementById("copyBtn");
  const withdrawBtn = document.getElementById("withdrawBtn");

  auth.onAuthStateChanged(async user => {
    if(!user){
      window.location.href = `${repoPath}/login.html`;
      return;
    }

    const uid = user.uid;
    const userDoc = await db.collection("users").doc(uid).get();
    if(!userDoc.exists) return;

    const data = userDoc.data();
    userEmailSpan.textContent = data.email;
    statusSpan.textContent = data.status;
    refCodeSpan.textContent = data.referralCode;

    // Generate referral link
    const referralLink = `${window.location.origin}${repoPath}/register.html?ref=${data.referralCode}`;
    refLinkInput.value = referralLink;

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(referralLink)
        .then(()=>alert("Referral link copied!"))
        .catch(()=>alert("Failed to copy link"));
    };

    // Referrals list (all accounts with status)
    const refSnap = await db.collection("users")
                            .where("referredBy","==",data.referralCode)
                            .get();
    referralsList.innerHTML = "";
    if(!refSnap.empty){
      refSnap.docs.forEach(doc => {
        const d = doc.data();
        const li = document.createElement("li");
        li.textContent = `${d.name || d.fullName} - Status: ${d.status}`;
        referralsList.appendChild(li);
      });
    } else {
      referralsList.innerHTML = "<li>No referrals yet</li>";
    }

    // Calculate earnings (only active referrals)
    const activeRefSnap = await db.collection("users")
                                  .where("referredBy","==",data.referralCode)
                                  .where("status","==","active")
                                  .get();
    let totalEarnings = 0;
    activeRefSnap.forEach(doc => totalEarnings += 50);
    earningsSpan.textContent = totalEarnings;

    // Withdraw button logic
    if(data.status !== "active"){
      withdrawBtn.disabled = true;
      withdrawBtn.textContent = "Activate account to withdraw";
    } else {
      withdrawBtn.disabled = false;
      withdrawBtn.textContent = "Withdraw";
    }

  });

  logoutBtn.onclick = async () => {
    await auth.signOut();
    window.location.href = `${repoPath}/login.html`;
  };
</script>

</body>
</html>
