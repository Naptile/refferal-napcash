<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NapCash | Register</title>
  <link rel="stylesheet" href="register.css" />
  <style>
    .register-container {
      padding: 20px;
      max-width: 400px;
      margin: auto;
    }
    .navbar ul.active { display: block; }
    .navbar ul { z-index: 999; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">NapCash</div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="services.html">Services</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="register.html" class="active">Register</a></li>
    </ul>
    <div class="menu-toggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <div class="register-container">
    <div class="logo-container">
      <img src="logo.png" alt="NapCash Logo">
    </div>
    <h1>Create Account</h1>

    <form id="registrationForm">
      <label for="username">Full Name</label>
      <input type="text" id="username" required>

      <label for="email">Email</label>
      <input type="email" id="email" required>

      <label for="phone">Phone</label>
      <input type="tel" id="phone" required>

      <label for="password">Password</label>
      <input type="password" id="password" required>

      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" required>

      <label for="referralCode">Referral Code (Optional)</label>
      <input type="text" id="referralCode">

      <button type="submit" id="registerBtn">Register & Pay 100 Ksh</button>
    </form>

    <p>Already have an account? <a href="login.html">Login</a></p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
      authDomain: "napcash-3e696.firebaseapp.com",
      projectId: "napcash-3e696",
      storageBucket: "napcash-3e696.firebasestorage.app",
      messagingSenderId: "720221815295",
      appId: "1:720221815295:web:e8b299b30909c6cc9927ca",
      measurementId: "G-QE6CJP9KJR"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    const PAYSTACK_PUBLIC_KEY = "pk_test_d03b79de883fb1a0d254a0046ae6e1c2d9b28b36";
    const form = document.getElementById("registrationForm");
    const registerBtn = document.getElementById("registerBtn");

    // Validate phone
    function isValidPhone(phone) { return /^(\+254|254|0)?7\d{8}$/.test(phone); }
    // Validate password
    function isStrongPassword(pw) { return pw.length >= 6 && /\d/.test(pw); }

    // Generate unique referral code
    async function generateReferralCode() {
      let code, exists = true;
      while (exists) {
        code = "NC" + Math.random().toString(36).substring(2, 8).toUpperCase();
        const snap = await firebase.firestore().collection("users").where("referralCode", "==", code).get();
        exists = !snap.empty;
      }
      return code;
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const fullName = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirm-password").value;
      const usedCode = document.getElementById("referralCode").value.trim() || null;

      if (!isValidPhone(phone)) { alert("Enter valid Kenyan phone."); return; }
      if (!isStrongPassword(password)) { alert("Password min 6 chars + number."); return; }
      if (password !== confirmPassword) { alert("Passwords do not match."); return; }

      registerBtn.disabled = true;
      registerBtn.innerText = "Processing...";

      // Check if user already exists
      const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
      if (methods.length > 0) { 
        alert("Email already in use. Please login."); 
        registerBtn.disabled = false; 
        registerBtn.innerText = "Register & Pay 100 Ksh"; 
        return;
      }

      const amountKES = 100;
      const txRef = "NCASH_" + Date.now();

      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: amountKES * 100,
        currency: "KES",
        ref: txRef,
        callback: function(response) { handlePaymentSuccess(response); },
        onClose: function() {
          alert("Payment closed. Registration not completed.");
          registerBtn.disabled = false;
          registerBtn.innerText = "Register & Pay 100 Ksh";
        }
      });
      handler.openIframe();

      async function handlePaymentSuccess(response) {
        try {
          const cred = await firebase.auth().createUserWithEmailAndPassword(email, password);
          const uid = cred.user.uid;

          const myCode = await generateReferralCode();
          const myLink = `${window.location.origin}/register.html?ref=${myCode}`;

          await firebase.firestore().collection("users").doc(uid).set({
            fullName,
            email,
            phone,
            referralCode: myCode,
            referralLink: myLink,
            referredBy: usedCode,
            wallet: 0,
            status: "active",
            totalReferrals: 0,
            earnings: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            paymentRef: response.reference
          });

          // Referral bonus
          if (usedCode) {
            const refSnap = await firebase.firestore().collection("users")
              .where("referralCode", "==", usedCode).limit(1).get();
            if (!refSnap.empty) {
              const refUser = refSnap.docs[0];
              if (refUser.id !== uid) {
                await firebase.firestore().collection("users").doc(refUser.id).update({
                  wallet: firebase.firestore.FieldValue.increment(50),
                  totalReferrals: firebase.firestore.FieldValue.increment(1),
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }
          }

          localStorage.setItem("referralCode", myCode);
          localStorage.setItem("referralLink", myLink);

          window.location.href = "dashboard.html";
        } catch (err) {
          console.error("[NapCash] Error:", err);
          alert("Payment succeeded but account creation failed. Contact support.");
          registerBtn.disabled = false;
          registerBtn.innerText = "Register & Pay 100 Ksh";
        }
      }
    });
  </script>
</body>
</html>
