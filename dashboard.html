<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NapCash â€“ Dashboard</title>
<link rel="stylesheet" href="styles/dash2.css">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
/* ... keep all your existing CSS here ... */
/* Hamburger for small screens */
.hamburger { display:none; font-size:2rem; cursor:pointer; color:orange; margin-right:10px; }
@media (max-width:768px){
  .hamburger{display:block;}
  .nav-links { display:none; flex-direction:column; background:#222; position:absolute; top:60px; left:0; width:100%; padding:15px; gap:10px; border-top:1px solid orange; }
}
</style>
</head>
<body>

<div class="nav">
  <div class="hamburger" id="hamburger">&#9776;</div>
  <div class="brand">NapCash</div>
  <div class="nav-links" id="navLinks">
    <button id="profileBtn" class="btn-orange">Profile</button>
    <button id="withdrawBtn" class="btn-orange">Withdraw</button>
    <button id="referralBtn" class="btn-orange">Referrals</button>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn-orange">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate</button>
      </div>
      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>
    </div>
    <div style="margin-top:20px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h3>Update Profile</h3>
    <input type="text" id="modalName" placeholder="Full Name">
    <input type="email" id="modalEmail" placeholder="Email">
    <input type="tel" id="modalPhone" placeholder="Phone">
    <button id="saveProfileBtn" class="btn-orange">Save</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const repoPath = "/refferal-napcash";
const whatsappNumber = "+254718439373";

// Hamburger toggle
const hamburger = document.getElementById("hamburger");
const navLinks = document.getElementById("navLinks");
hamburger.onclick = () => { navLinks.style.display = navLinks.style.display==="flex"?"none":"flex"; };
navLinks.querySelectorAll("button").forEach(btn=>{ btn.onclick = ()=>{ if(window.innerWidth<=768) navLinks.style.display="none"; }; });

const userEmailSpan = document.getElementById("userEmail");
const statusSpan = document.getElementById("status");
const refCodeSpan = document.getElementById("refCode");
const earningsSpan = document.getElementById("earnings");
const refLinkInput = document.getElementById("refLink");
const referralsList = document.getElementById("referralsList");
const logoutBtn = document.getElementById("logoutBtn");
const copyBtn = document.getElementById("copyBtn");
const activateBtn = document.getElementById("activateBtn");
const withdrawBtn = document.getElementById("withdrawBtn");

// Profile modal
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const closeModal = document.getElementById("closeModal");
const modalName = document.getElementById("modalName");
const modalEmail = document.getElementById("modalEmail");
const modalPhone = document.getElementById("modalPhone");
const saveProfileBtn = document.getElementById("saveProfileBtn");

function openWhatsApp(fullName){
  const message = encodeURIComponent(`Hi Admin, I want to activate my account. My name is ${fullName}`);
  window.open(`https://wa.me/${whatsappNumber.replace(/\D/g,'')}?text=${message}`,"_blank");
}

auth.onAuthStateChanged(async user=>{
  if(!user){ window.location.href=`${repoPath}/login.html`; return; }
  const uid = user.uid;
  const userDoc = await db.collection("users").doc(uid).get();
  if(!userDoc.exists) return;
  const data = userDoc.data();
  const fullName = data.fullName || data.name || "User";
  userEmailSpan.textContent = data.email;
  statusSpan.textContent = data.status;
  refCodeSpan.textContent = data.referralCode;

  // Referral link
  const referralLink = `${window.location.origin}${repoPath}/register.html?ref=${data.referralCode}`;
  refLinkInput.value = referralLink;
  copyBtn.onclick = ()=>navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!")).catch(()=>alert("Failed to copy"));

  // Referred accounts
  const refSnap = await db.collection("users").where("referredBy","==",data.referralCode).get();
  referralsList.innerHTML="";
  if(!refSnap.empty){
    refSnap.docs.forEach(doc=>{
      const d=doc.data();
      const li=document.createElement("li");
      li.style.display="flex"; li.style.justifyContent="space-between"; li.style.alignItems="center";
      li.style.padding="10px"; li.style.borderRadius="6px"; li.style.marginBottom="8px"; li.style.backgroundColor="#222";
      const nameSpan=document.createElement("span"); nameSpan.textContent=d.fullName || d.name;
      const statusSpanBadge=document.createElement("span"); statusSpanBadge.textContent=d.status.toUpperCase();
      statusSpanBadge.classList.add("status");
      statusSpanBadge.style.backgroundColor = d.status==="active"?"green":"orange";
      li.appendChild(nameSpan); li.appendChild(statusSpanBadge);
      referralsList.appendChild(li);
    });
  } else referralsList.innerHTML="<li>No referrals yet</li>";

  // Earnings only from active referrals
  const activeRefSnap = await db.collection("users").where("referredBy","==",data.referralCode).where("status","==","active").get();
  let totalEarnings=0; activeRefSnap.forEach(doc=>totalEarnings+=50); earningsSpan.textContent=totalEarnings;

  // Withdraw button logic
  if(data.status!=="active"){
    withdrawBtn.textContent="Activate account to withdraw";
    withdrawBtn.onclick=()=>openWhatsApp(fullName);
  } else {
    const withdrawalRequested = data.withdrawalRequested || false;
    if(withdrawalRequested){
      withdrawBtn.textContent="Pending Withdrawal";
      withdrawBtn.disabled=true;
    } else {
      withdrawBtn.textContent="Request Withdrawal";
      withdrawBtn.disabled=false;
      withdrawBtn.onclick=async ()=>{
        await db.collection("users").doc(uid).update({
          withdrawalRequested:true,
          withdrawalRequestedAt:firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Withdrawal requested successfully!");
        withdrawBtn.textContent="Pending Withdrawal";
        withdrawBtn.disabled=true;
      };
    }
  }

  // Status activate button
  if(data.status!=="active"){
    activateBtn.style.display="inline-block";
    activateBtn.onclick=()=>openWhatsApp(fullName);
  } else activateBtn.style.display="none";

  // Profile modal
  profileBtn.onclick=()=>{
    modalName.value=data.fullName || data.name || "";
    modalEmail.value=data.email || "";
    modalPhone.value=data.phone || "";
    profileModal.style.display="flex";
  };
});

closeModal.onclick=()=>profileModal.style.display="none";
window.onclick=(e)=>{if(e.target===profileModal) profileModal.style.display="none";};

saveProfileBtn.onclick=async ()=>{
  const user = auth.currentUser; if(!user) return;
  const uid = user.uid;
  await db.collection("users").doc(uid).update({
    fullName: modalName.value,
    email: modalEmail.value,
    phone: modalPhone.value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Profile updated!");
  profileModal.style.display="none";
};

// Logout
logoutBtn.onclick=async ()=>{
  await auth.signOut();
  window.location.href=`${repoPath}/login.html`;
};
</script>
</body>
</html>
