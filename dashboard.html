<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash â€“ Dashboard</title>
  <link rel="stylesheet" href="styles/dash2.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* Mobile adjustments */
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
      .nav { flex-direction: column; align-items: flex-start; padding: 15px; position: relative; }
      .info-card { padding: 15px; font-size: 0.95rem; }
      .referral-list li { font-size: 0.9rem; padding: 10px; }
      .hero { padding: 20px 10px; }
      .card { padding: 20px; }
      #refLink { font-size: 0.9rem; }
      button { padding: 12px; font-size: 0.95rem; }
    }

    .btn-orange {
      background-color: orange;
      border: none;
      color: black;
      font-weight: bold;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-orange:hover {
      background-color: #ff9900;
      color: white;
    }
    input#refLink {
      width: 100%;
      padding: 5px;
      border-radius: 5px;
      border: none;
      color: black;
      margin-bottom: 8px;
    }

    /* Hamburger menu */
    .hamburger { display:none; cursor:pointer; flex-direction:column; gap:4px; margin-left:10px; }
    .hamburger div { width:25px; height:3px; background:black; transition:0.3s; }

    .menu-items { display:flex; gap:10px; align-items:center; }
    @media (max-width:768px) { 
      .menu-items { display:none; flex-direction:column; background:#fff; position:absolute; top:60px; left:0; width:100%; padding:10px 0; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:99; }
      .menu-items button, .menu-items span { width:100%; text-align:left; padding:10px 20px; margin:0; }
      .hamburger { display:flex; }
    }
  </style>
</head>
<body class="bg">

<div class="nav">
  <div class="brand">NapCash</div>
  <div class="menu-items">
    <button id="profileBtn" class="btn-orange">Profile</button>
    <button id="withdrawInfoBtn" class="btn-orange">Withdrawal</button>
    <button id="referralBtn" class="btn-orange">Referrals</button>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn-orange">Logout</button>
  </div>
  <div class="hamburger" id="hamburger">
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>

    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button id="activateBtn" class="btn-orange" style="margin-top:10px;">Activate</button>
      </div>

      <div class="info-card">
        <h3>Your Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>

      <div class="info-card">
        <h3>Your Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
      </div>

      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button id="copyBtn" class="btn-orange">Copy Link</button>
      </div>

      <div class="info-card">
        <h3>Withdraw</h3>
        <button id="withdrawBtn" class="btn-orange">Activate account to withdraw</button>
      </div>
    </div>

    <div style="margin-top:30px;">
      <h3>People You Referred</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
    authDomain: "napcash-3e696.firebaseapp.com",
    projectId: "napcash-3e696",
    storageBucket: "napcash-3e696.firebasestorage.app",
    messagingSenderId: "720221815295",
    appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const repoPath = "/refferal-napcash";

  const userEmailSpan = document.getElementById("userEmail");
  const statusSpan = document.getElementById("status");
  const refCodeSpan = document.getElementById("refCode");
  const earningsSpan = document.getElementById("earnings");
  const refLinkInput = document.getElementById("refLink");
  const referralsList = document.getElementById("referralsList");
  const logoutBtn = document.getElementById("logoutBtn");
  const copyBtn = document.getElementById("copyBtn");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const activateBtn = document.getElementById("activateBtn");

  const whatsappNumber = "+254718439373"; 

  function openWhatsApp(fullName) {
    const message = encodeURIComponent(`Hi Admin, I want to activate my account. My name is ${fullName}`);
    const url = `https://wa.me/${whatsappNumber.replace(/\D/g,'')}?text=${message}`;
    window.open(url, "_blank");
  }

  auth.onAuthStateChanged(async user => {
    if(!user){ window.location.href = `${repoPath}/login.html`; return; }
    const uid = user.uid;
    const userDoc = await db.collection("users").doc(uid).get();
    if(!userDoc.exists) return;

    const data = userDoc.data();
    const fullName = data.fullName || data.name || "User";

    userEmailSpan.textContent = data.email;
    statusSpan.textContent = data.status;
    refCodeSpan.textContent = data.referralCode;

    // Referral link
    const referralLink = `${window.location.origin}${repoPath}/register.html?ref=${data.referralCode}`;
    refLinkInput.value = referralLink;

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(referralLink)
        .then(()=>alert("Referral link copied!"))
        .catch(()=>alert("Failed to copy link"));
    };

    // Referred accounts with status badges
    const refSnap = await db.collection("users")
                            .where("referredBy","==",data.referralCode)
                            .get();
    referralsList.innerHTML = "";
    if(!refSnap.empty){
      refSnap.docs.forEach(doc => {
        const d = doc.data();
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";
        li.style.padding = "10px";
        li.style.borderRadius = "6px";
        li.style.marginBottom = "8px";
        li.style.backgroundColor = "#222";
        
        const nameSpan = document.createElement("span");
        nameSpan.textContent = d.fullName || d.name;

        const statusSpanBadge = document.createElement("span");
        statusSpanBadge.textContent = d.status.toUpperCase();
        statusSpanBadge.style.padding = "4px 8px";
        statusSpanBadge.style.borderRadius = "4px";
        statusSpanBadge.style.fontWeight = "bold";
        statusSpanBadge.style.color = "#fff";
        statusSpanBadge.style.fontSize = "0.85rem";
        statusSpanBadge.style.backgroundColor = d.status === "active" ? "green" : "orange";

        li.appendChild(nameSpan);
        li.appendChild(statusSpanBadge);
        referralsList.appendChild(li);
      });
    } else {
      referralsList.innerHTML = "<li>No referrals yet</li>";
    }

    // Earnings only from active referrals
    const activeRefSnap = await db.collection("users")
                                  .where("referredBy","==",data.referralCode)
                                  .where("status","==","active")
                                  .get();
    let totalEarnings = 0;
    activeRefSnap.forEach(doc => totalEarnings += 50);
    earningsSpan.textContent = totalEarnings;

    // Withdraw button
    if(data.status !== "active"){
      withdrawBtn.textContent = "Activate account to withdraw";
      withdrawBtn.onclick = () => openWhatsApp(fullName);
    } else {
      withdrawBtn.textContent = "Withdraw";
      withdrawBtn.onclick = () => alert("Withdraw functionality not implemented yet");
    }

    // Status card activate button
    if(data.status !== "active"){
      activateBtn.style.display = "inline-block";
      activateBtn.onclick = () => openWhatsApp(fullName);
    } else {
      activateBtn.style.display = "none";
    }
  });

  logoutBtn.onclick = async () => {
    await auth.signOut();
    window.location.href = `${repoPath}/login.html`;
  };

  // Hamburger menu functionality
  const hamburger = document.getElementById("hamburger");
  const menuItems = document.querySelector(".menu-items");

  hamburger.addEventListener("click", () => {
    if(menuItems.style.display === "flex") menuItems.style.display = "none";
    else menuItems.style.display = "flex";
  });

  document.querySelectorAll(".menu-items button").forEach(btn => {
    btn.addEventListener("click", () => {
      if(window.innerWidth <= 768) menuItems.style.display = "none";
    });
  });
</script>

</body>
</html>
