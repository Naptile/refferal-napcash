<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NapCash â€“ Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
  body {margin:0; font-family: Arial, sans-serif; background:#000; color:#fff;}
  .nav {display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#111;}
  .brand {color:orange; font-weight:bold; font-size:1.5rem;}
  .menu {display:flex; gap:15px;}
  .menu a {color:#fff; text-decoration:none; font-weight:bold;}
  .hamburger {display:none; cursor:pointer; font-size:1.5rem;}
  .hero {padding:20px;}
  .card {background:#111; padding:20px; border-radius:10px; max-width:1000px; margin:auto;}
  .dashboard-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px;}
  .info-card {background:#222; padding:15px; border-radius:8px; text-align:center;}
  .btn-orange {background:orange;color:black;font-weight:bold;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
  .btn-orange:hover {background:#ff9900;color:white;}
  #refLink {width:100%;padding:5px;border-radius:5px;border:none;color:#000;margin-bottom:5px;}
  .referral-list li {display:flex;justify-content:space-between; padding:8px; margin-bottom:5px; background:#222; border-radius:5px;}
  .badge-pending {background:orange;padding:2px 6px;border-radius:4px;font-size:0.8rem;}
  .badge-active {background:green;padding:2px 6px;border-radius:4px;font-size:0.8rem;}
  /* Profile modal */
  #profileModal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;}
  #profileContent {background:#111; padding:20px; border-radius:10px; width:90%; max-width:400px;}
  #profileContent input {width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:none;}
  /* Responsive */
  @media(max-width:700px){
    .menu {display:none; flex-direction:column; background:#111; position:absolute; top:60px; right:0; padding:10px; border-radius:5px;}
    .menu.show {display:flex;}
    .hamburger {display:block; color:orange;}
  }
</style>
</head>
<body>

<div class="nav">
  <div class="brand">NapCash</div>
  <div class="hamburger" id="hamburger">&#9776;</div>
  <div class="menu" id="menu">
    <a href="#" id="profileBtn">Profile</a>
    <a href="#" id="withdrawBtn">Withdraw</a>
    <a href="#" id="referralBtn">Referrals</a>
    <a href="#" id="logoutBtn">Logout</a>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Dashboard</h2>
    <div class="dashboard-grid">
      <div class="info-card">
        <h3>Status</h3>
        <p id="status">Loading...</p>
        <button class="btn-orange" id="activateBtn">Activate Account</button>
      </div>
      <div class="info-card">
        <h3>Referral Code</h3>
        <p id="refCode">Loading...</p>
      </div>
      <div class="info-card">
        <h3>Earnings</h3>
        <p>KSh <span id="earnings">0</span></p>
      </div>
      <div class="info-card">
        <h3>Referral Link</h3>
        <input type="text" id="refLink" readonly>
        <button class="btn-orange" id="copyBtn">Copy Link</button>
      </div>
    </div>

    <!-- Referred Users -->
    <div id="referralSection" style="margin-top:20px; display:none;">
      <h3>Your Referrals</h3>
      <ul id="referralsList" class="referral-list">
        <li>Loading...</li>
      </ul>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal">
  <div id="profileContent">
    <h3>Update Profile</h3>
    <input type="text" id="updName" placeholder="Full Name">
    <input type="email" id="updEmail" placeholder="Email">
    <input type="tel" id="updPhone" placeholder="Phone Number">
    <button class="btn-orange" id="saveProfile">Save</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const repoPath="/refferal-napcash";

const userEmailSpan=document.getElementById("status");
const statusSpan=document.getElementById("status");
const refCodeSpan=document.getElementById("refCode");
const earningsSpan=document.getElementById("earnings");
const refLinkInput=document.getElementById("refLink");
const referralsList=document.getElementById("referralsList");

const logoutBtn=document.getElementById("logoutBtn");
const copyBtn=document.getElementById("copyBtn");
const withdrawBtn=document.getElementById("withdrawBtn");
const referralBtn=document.getElementById("referralBtn");
const profileBtn=document.getElementById("profileBtn");
const profileModal=document.getElementById("profileModal");
const saveProfile=document.getElementById("saveProfile");
const activateBtn=document.getElementById("activateBtn");
const hamburger=document.getElementById("hamburger");
const menu=document.getElementById("menu");

const whatsappNumber="+254718439373";

function openWhatsApp(fullName){
  const message=encodeURIComponent(`Hi Admin, I want to activate my account. My name is ${fullName}`);
  const url=`https://wa.me/${whatsappNumber.replace(/\D/g,'')}?text=${message}`;
  window.open(url,"_blank");
}

// Hamburger toggle
hamburger.onclick=()=>{menu.classList.toggle("show");};
document.querySelectorAll(".menu a").forEach(a=>a.addEventListener("click",()=>{menu.classList.remove("show");}));

auth.onAuthStateChanged(async user=>{
  if(!user){window.location.href=`${repoPath}/login.html`; return;}
  const uid=user.uid;
  const userDoc=await db.collection("users").doc(uid).get();
  if(!userDoc.exists) return;
  const data=userDoc.data();
  const fullName=data.fullName||data.name||"User";

  // Dashboard info
  document.getElementById("userEmail").textContent=data.email;
  statusSpan.textContent=data.status;
  refCodeSpan.textContent=data.referralCode;

  const referralLink=`${window.location.origin}${repoPath}/register.html?ref=${data.referralCode}`;
  refLinkInput.value=referralLink;

  copyBtn.onclick=()=>navigator.clipboard.writeText(referralLink).then(()=>alert("Referral link copied!"));

  // Referred users
  referralBtn.onclick=()=>{
    document.getElementById("referralSection").style.display="block";
    referralsList.innerHTML="";
    db.collection("users").where("referredBy","==",data.referralCode).get().then(snapshot=>{
      if(snapshot.empty){referralsList.innerHTML="<li>No referrals yet</li>"; return;}
      snapshot.docs.forEach(doc=>{
        const d=doc.data();
        const li=document.createElement("li");
        li.innerHTML=`<span>${d.fullName||d.name}</span> <span class="${d.status==="active"?"badge-active":"badge-pending"}">${d.status.toUpperCase()}</span>`;
        referralsList.appendChild(li);
      });
    });
  };

  // Earnings only from active referrals
  const activeRefSnap=await db.collection("users").where("referredBy","==",data.referralCode).where("status","==","active").get();
  let totalEarnings=0; activeRefSnap.forEach(doc=>totalEarnings+=50);
  earningsSpan.textContent=totalEarnings;

  // Withdraw
  withdrawBtn.onclick=()=>{if(data.status!=="active"){openWhatsApp(fullName);}else{alert("Withdraw functionality not implemented yet");}};

  // Activate account button
  activateBtn.onclick=()=>openWhatsApp(fullName);

  // Profile
  profileBtn.onclick=()=>{
    profileModal.style.display="flex";
    document.getElementById("updName").value=data.fullName||"";
    document.getElementById("updEmail").value=data.email||"";
    document.getElementById("updPhone").value=data.phone||"";
  };

  saveProfile.onclick=async()=>{
    const newName=document.getElementById("updName").value;
    const newEmail=document.getElementById("updEmail").value;
    const newPhone=document.getElementById("updPhone").value;
    await db.collection("users").doc(uid).update({
      fullName:newName,
      email:newEmail,
      phone:newPhone,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    profileModal.style.display="none";
    alert("Profile updated!");
  };
});

window.onclick=function(event){if(event.target===profileModal){profileModal.style.display="none";}}
logoutBtn.onclick=async()=>{await auth.signOut(); window.location.href=`${repoPath}/login.html`;};
</script>
</body>
</html>
