<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapCash â€“ Admin Dashboard</title>
  <link rel="stylesheet" href="styles/admin.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; }
    .nav { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111; flex-wrap:wrap; }
    .brand { font-size:1.5rem; color:orange; font-weight:bold; }
    .hero { max-width:1200px; margin:20px auto; padding:10px; }
    .card { background:#111; padding:20px; border-radius:12px; overflow-x:auto; }
    input, select, button { margin:5px 0; padding:8px; border-radius:5px; border:none; }
    button { cursor:pointer; background:orange; color:#000; font-weight:bold; transition:0.3s; }
    button:hover { background:#ff9900; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; text-align:left; border-bottom:1px solid #222; }
    th { background:#222; }
    td button { margin-right:5px; }
    @media(max-width:768px){
      .nav { flex-direction:column; align-items:flex-start; }
      .search-bar { display:flex; flex-direction:column; }
      input, select, button { width:100%; margin-bottom:5px; }
      table { font-size:0.9rem; }
    }
    /* Modal */
    #confirmModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    #confirmModal div { background:#111; padding:20px; border-radius:10px; max-width:400px; width:90%; text-align:center; }
    #confirmModal button { margin:5px; }
  </style>
</head>
<body>

<div class="nav">
  <div class="brand">NapCash Admin</div>
  <div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="hero">
  <div class="card">
    <h2>Admin Dashboard</h2>

    <div class="add-member-form">
      <h3>Add New Member</h3>
      <input type="text" id="newFullName" placeholder="Full Name" required>
      <input type="email" id="newEmail" placeholder="Email" required>
      <input type="text" id="newPhone" placeholder="Phone Number" required>
      <input type="text" id="newReferralCode" placeholder="Referral Code (optional)">
      <input type="text" id="newReferredBy" placeholder="Referred By (optional)">
      <button id="addMemberBtn">Add Member</button>
    </div>

    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by name, email, phone, or referral code...">
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="active">Active</option>
        <option value="deactivated">Deactivated</option>
      </select>
      <button id="searchBtn">Search</button>
      <button id="resetBtn">Reset</button>
      <button id="exportBtn">Export All Users</button>
      <button id="exportReferralsBtn">Export Referrals Only</button>
    </div>

    <h3>All Users</h3>
    <table class="users-table">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Referral Code</th>
          <th>Earnings (KSh)</th>
          <th>Referred By</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr><td colspan="8">Loading users...</td></tr>
      </tbody>
    </table>

    <h3 style="margin-top:40px;">Withdrawal Requests</h3>
    <table class="users-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Amount (KSh)</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTableBody">
        <tr><td colspan="6">Loading withdrawals...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal">
  <div>
    <p id="confirmMessage"></p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDybgITS1zttYLSa1_vsV0vYLzqbr42abA",
  authDomain: "napcash-3e696.firebaseapp.com",
  projectId: "napcash-3e696",
  storageBucket: "napcash-3e696.firebasestorage.app",
  messagingSenderId: "720221815295",
  appId: "1:720221815295:web:e8b299b30909c6cc9927ca"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const usersTableBody = document.getElementById("usersTableBody");
const withdrawalsTableBody = document.getElementById("withdrawalsTableBody");
const logoutBtn = document.getElementById("logoutBtn");
let allUsers = [];

// Confirmation modal
const confirmModal = document.getElementById("confirmModal");
const confirmMessage = document.getElementById("confirmMessage");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
let confirmAction = null;

function showConfirm(message, action){
  confirmMessage.textContent = message;
  confirmAction = action;
  confirmModal.style.display = "flex";
}

confirmNo.onclick = () => { confirmModal.style.display = "none"; confirmAction=null; };
confirmYes.onclick = async () => { if(confirmAction) await confirmAction(); confirmModal.style.display = "none"; confirmAction=null; };

// Auth
auth.onAuthStateChanged(async user => {
  if(!user) return window.location.href = "login.html";
  loadUsers();
  loadWithdrawals();
});

// Add Member
document.getElementById("addMemberBtn").addEventListener("click", async () => {
  const fullName = document.getElementById("newFullName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const phone = document.getElementById("newPhone").value.trim();
  const referralCode = document.getElementById("newReferralCode").value.trim() || null;
  const referredBy = document.getElementById("newReferredBy").value.trim() || null;
  if(!fullName||!email||!phone){ alert("Fill all required fields."); return; }

  await db.collection("users").add({
    fullName, email, phone, referralCode, referredBy,
    status:"pending", earnings:0, createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("New member added!");
  document.getElementById("newFullName").value="";
  document.getElementById("newEmail").value="";
  document.getElementById("newPhone").value="";
  document.getElementById("newReferralCode").value="";
  document.getElementById("newReferredBy").value="";
  loadUsers();
});

// Load Users
async function loadUsers(){
  const snapshot = await db.collection("users").orderBy("createdAt","desc").get();
  allUsers = snapshot.docs.map(doc => ({ id:doc.id, ...doc.data() }));
  renderUsers(allUsers);
}

function renderUsers(users){
  if(users.length===0){ usersTableBody.innerHTML="<tr><td colspan='8'>No users found</td></tr>"; return; }
  usersTableBody.innerHTML="";
  users.forEach(u=>{
    const tr = document.createElement("tr");
    if(u.status==="pending") tr.classList.add("pending");
    if(u.status==="deactivated") tr.classList.add("deactivated");

    let actionButtons = "";
    if(u.status==="pending"){ 
      actionButtons += `<button onclick="activateUser('${u.id}')">Activate</button>`;
      actionButtons += `<button onclick="deactivateUser('${u.id}')">Deactivate</button>`;
    } else if(u.status==="active"){ actionButtons += `<button onclick="deactivateUser('${u.id}')">Deactivate</button>`; }
    else if(u.status==="deactivated"){ actionButtons += `<button onclick="activateUser('${u.id}')">Activate</button>`; }

    actionButtons += `<button onclick="deleteUser('${u.id}')">Delete</button>`;

    tr.innerHTML = `
      <td>${u.fullName || "N/A"}</td>
      <td>${u.email || "N/A"}</td>
      <td>${u.phone || "N/A"}</td>
      <td>${u.status || "pending"}</td>
      <td>${u.referralCode || "N/A"}</td>
      <td>${u.earnings || 0}</td>
      <td>${u.referredBy || "None"}</td>
      <td>${actionButtons}</td>
    `;
    usersTableBody.appendChild(tr);
  });
}

// Actions
function activateUser(userId){ showConfirm("Activate this user?", async ()=>{ await db.collection("users").doc(userId).update({status:"active"}); loadUsers(); }); }
function deactivateUser(userId){ showConfirm("Deactivate this user?", async ()=>{ await db.collection("users").doc(userId).update({status:"deactivated"}); loadUsers(); }); }
function deleteUser(userId){ showConfirm("Delete this user permanently?", async ()=>{ await db.collection("users").doc(userId).delete(); loadUsers(); }); }

// Load Withdrawals
async function loadWithdrawals(){
  const snapshot = await db.collection("withdrawals").orderBy("createdAt","desc").get();
  if(snapshot.empty){ withdrawalsTableBody.innerHTML="<tr><td colspan='6'>No withdrawals yet</td></tr>"; return; }
  withdrawalsTableBody.innerHTML="";
  for(const doc of snapshot.docs){
    const w = doc.data();
    const userDoc = await db.collection("users").doc(w.userId).get();
    const userData = userDoc.exists ? userDoc.data() : {};
    const tr = document.createElement("tr");
    const date = w.createdAt ? w.createdAt.toDate().toLocaleString() : "Unknown";
    tr.innerHTML = `
      <td>${userData.fullName || "Unknown"}</td>
      <td>${userData.email || "Unknown"}</td>
      <td>${w.amount}</td>
      <td>${w.status}</td>
      <td>${date}</td>
      <td>${w.status==="pending" ? `<button onclick="markPaid('${doc.id}')">Mark Paid</button>` : "â€”"}</td>
    `;
    withdrawalsTableBody.appendChild(tr);
  }
}

async function markPaid(withdrawalId){ await db.collection("withdrawals").doc(withdrawalId).update({status:"paid"}); loadWithdrawals(); }

// Export & Logout
document.getElementById("exportBtn").addEventListener("click", ()=>{
  if(allUsers.length===0){ alert("No users to export!"); return; }
  const headers = ["Full Name","Email","Phone","Status","Referral Code","Earnings","Referred By"];
  const rows = allUsers.map(u=>[`"${u.fullName||'N/A'}"`,`"${u.email||'N/A'}"`,`"${u.phone||'N/A'}"`,`"${u.status||'pending'}"`,`"${u.referralCode||'N/A'}"`,`"${u.earnings||0}"`,`"${u.referredBy||'None'}"`]);
  downloadCSV([headers.join(","), ...rows.map(r=>r.join(","))].join("\n"), "napcash_users.csv");
});

document.getElementById("exportReferralsBtn").addEventListener("click", ()=>{
  const rows = allUsers.filter(u=>u.referredBy && u.referredBy!=="None").map(u=>[`"${u.fullName||u.email}"`,`"${u.referredBy}"`]);
  if(rows.length===0){ alert("No referral data found!"); return; }
  downloadCSV([["User","Referred By"].join(","), ...rows.map(r=>r.join(","))].join("\n"), "napcash_referrals.csv");
});

function downloadCSV(content, filename){
  const blob = new Blob([content], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.click();
}

logoutBtn.onclick = async ()=>{ await auth.signOut(); window.location.href="login.html"; };
</script>
</body>
</html>
